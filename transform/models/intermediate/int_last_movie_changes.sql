{{ config(materialized='view') }}

with tmdb_movies_and_changes as (
select 
    stg_changes.tmdb_id,
    stg_changes.imdb_id,
    stg_changes.status,
    stg_changes.original_title,
    stg_changes.release_date,
    stg_changes.budget,
    stg_changes.revenue,
    stg_changes.runtime,
    stg_changes.popularity,
    stg_changes.vote_average,
    stg_changes.vote_count,
    stg_changes.original_language,
    stg_changes.genres,
    stg_changes.production_companies,
    stg_changes.production_countries,
    stg_changes.spoken_languages,
    stg_changes.origin_country,
    stg_changes.credits,
    stg_changes.overview,
    stg_changes.poster_path,
    stg_changes.tagline,
    stg_changes.title,
    stg_changes.video,
    stg_changes.belongs_to_collection__id,
    stg_changes.belongs_to_collection__name,
    stg_changes.belongs_to_collection__poster_path,
    stg_changes.belongs_to_collection__backdrop_path,
    stg_changes.adult,
    stg_changes.backdrop_path,
    stg_changes.load_id,
    stg_changes.load_date,
    stg_changes.dlt_id 
from {{ref('stg_changes')}} as stg_changes
union all
select 
    stg_movies.tmdb_id,
    stg_movies.imdb_id,
    stg_movies.status,
    stg_movies.original_title,
    stg_movies.release_date,
    stg_movies.budget,
    stg_movies.revenue,
    stg_movies.runtime,
    stg_movies.popularity,
    stg_movies.vote_average,
    stg_movies.vote_count,
    stg_movies.original_language,
    stg_movies.genres,
    stg_movies.production_companies,
    stg_movies.production_countries,
    stg_movies.spoken_languages,
    stg_movies.origin_country,
    stg_movies.credits,
    stg_movies.overview,
    stg_movies.poster_path,
    stg_movies.tagline,
    stg_movies.title,
    stg_movies.video,
    stg_movies.belongs_to_collection__id,
    stg_movies.belongs_to_collection__name,
    stg_movies.belongs_to_collection__poster_path,
    stg_movies.belongs_to_collection__backdrop_path,
    stg_movies.adult,
    stg_movies.backdrop_path,
    stg_movies.load_id,
    stg_movies.load_date,
    stg_movies.dlt_id 
from {{ref('stg_movies')}} as stg_movies
 ),
 last_movie_changes as (
 select 
    tmdb_id,
    imdb_id,
    status,
    ROW_NUMBER() OVER(PARTITION BY tmdb_id ORDER BY  load_id DESC) as row_num,
    original_title,
    release_date,
    budget,
    revenue,
    runtime,
    popularity,
    vote_average,
    vote_count,
    original_language,
    genres,
    production_companies,
    production_countries,
    spoken_languages,
    origin_country,
    credits,
    overview,
    poster_path,
    tagline,
    title,
    video,
    belongs_to_collection__id,
    belongs_to_collection__name,
    belongs_to_collection__poster_path,
    belongs_to_collection__backdrop_path,
    adult,
    backdrop_path,
    load_id,
    load_date,
    dlt_id 
from tmdb_movies_and_changes
qualify row_num = 1)

select 
    tmdb_id,
    imdb_id,
    status,
    original_title,
    release_date,
    budget,
    revenue,
    runtime,
    popularity,
    vote_average,
    vote_count,
    original_language,
    genres,
    production_companies,
    production_countries,
    spoken_languages,
    origin_country,
    credits,
    overview,
    poster_path,
    tagline,
    title,
    video,
    belongs_to_collection__id,
    belongs_to_collection__name,
    belongs_to_collection__poster_path,
    belongs_to_collection__backdrop_path,
    adult,
    backdrop_path,
    load_id,
    load_date,
    dlt_id 
from last_movie_changes




